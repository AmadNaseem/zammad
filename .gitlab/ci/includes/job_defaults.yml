default:
  image: $CI_REGISTRY/docker/zammad-ci:3.0.4

  tags:
    - docker

  cache: !reference [.cache, read_only]

  # Artifacts are stored for failed jobs
  artifacts:
    expire_in: 1 week
    when: on_failure
    paths:
      - tmp/screenshot*
      - tmp/screenshots/*
      - log/*.log

  interruptible: true

  # Initialize application env
  before_script:
    - source /etc/profile.d/rvm.sh
    - echo -e "\\e[0Ksection_start:`date +%s`:bundle_install[collapsed=true]\\r\\e[0Kbundle install"
    - bundle config set --local frozen 'true'
    - bundle config set --local path 'vendor'
    - bundle install -j $(nproc)
    - echo -e "\\e[0Ksection_end:`date +%s`:bundle_install\\r\\e[0K"
    - bundle exec ruby .gitlab/configure_environment.rb
    - source .gitlab/environment.env

  after_script:
    - .gitlab/environment_info.sh > log/environment_info.log
    # Copy logs from other containers to store them as artifacts.
    - cp /builds/*.log log/ || true
